# Task 1: Kubernetes Cluster Monitoring with Prometheus

## Kube Prometheus Stack Components

### 1. Prometheus Operator:
   The Prometheus Operator simplifies the deployment and management of Prometheus instances and related monitoring components in Kubernetes. It follows the operator pattern to automate the configuration of Prometheus, Alertmanager, and related resources.

### 2. Prometheus:
   Prometheus is an open-source monitoring and alerting toolkit designed for reliability and simplicity. It collects metrics from configured targets, stores these metrics, and allows querying and visualization of the collected data. In the Kube Prometheus Stack, it serves as the core metric collection and storage component.

### 3. Alertmanager:
   Alertmanager handles alerts sent by client applications such as Prometheus. It manages the routing, grouping, and notification of alerts to various receivers (email, Slack, PagerDuty, etc.) based on defined rules and configurations.

### 4. Grafana:
   Grafana is a popular open-source platform for monitoring and observability. In the Kube Prometheus Stack, Grafana serves as the visualization tool, providing a user-friendly interface to create dashboards and visualize Prometheus-collected metrics.

### 5. kube-state-metrics:
   kube-state-metrics is a service that listens to the Kubernetes API server and generates metrics about the state of various Kubernetes objects like deployments, pods, nodes, etc. These metrics are valuable for understanding the state and health of the Kubernetes cluster.

### 6. node-exporter:
   The node-exporter is a Prometheus exporter that collects system-level metrics from nodes in a Kubernetes cluster. It exposes detailed information about hardware and OS resources (CPU, memory, disk, network usage, etc.) which are crucial for monitoring node health and performance.

### 7. kube-rbac-proxy:
   kube-rbac-proxy is a component that enables secure access to the Kubernetes API server for fetching metrics. It assists in providing fine-grained access control and ensures that only authorized entities can retrieve metrics.

### 8. CoreDNS:
   CoreDNS is a DNS server that is often used in Kubernetes clusters for service discovery. Though not primarily a monitoring component, it plays a role in ensuring proper network resolution, which indirectly impacts monitoring and service availability.


## Install the Kube Prometheus Stack to your Kubernetes cluster

```bash
❯ kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS    RESTARTS      AGE
pod/alertmanager-monitoring-kube-prometheus-alertmanager-0   2/2     Running   0             18m
pod/app-app-python-0                                         1/1     Running   1 (57m ago)   6d21h
pod/app-app-python-1                                         1/1     Running   1 (57m ago)   6d21h
pod/monitoring-grafana-6f8d546676-nsv5g                      3/3     Running   0             20m
pod/monitoring-kube-prometheus-operator-5fbb66b4b-zvtg9      1/1     Running   0             20m
pod/monitoring-kube-state-metrics-74f4d8858f-mxmxl           1/1     Running   0             20m
pod/monitoring-prometheus-node-exporter-f8bnm                1/1     Running   0             20m
pod/prometheus-monitoring-kube-prometheus-prometheus-0       2/2     Running   0             18m

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-monitoring-kube-prometheus-alertmanager   1/1     18m
statefulset.apps/app-app-python                                         2/2     6d21h
statefulset.apps/prometheus-monitoring-kube-prometheus-prometheus       1/1     18m

NAME                                              TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                     ClusterIP      None             <none>        9093/TCP,9094/TCP,9094/UDP   18m
service/app-app-python                            LoadBalancer   10.107.79.19     <pending>     80:31441/TCP                 6d21h
service/kubernetes                                ClusterIP      10.96.0.1        <none>        443/TCP                      6d23h
service/monitoring-grafana                        ClusterIP      10.104.53.220    <none>        80/TCP                       20m
service/monitoring-kube-prometheus-alertmanager   ClusterIP      10.97.120.219    <none>        9093/TCP,8080/TCP            20m
service/monitoring-kube-prometheus-operator       ClusterIP      10.103.138.120   <none>        443/TCP                      20m
service/monitoring-kube-prometheus-prometheus     ClusterIP      10.108.12.54     <none>        9090/TCP,8080/TCP            20m
service/monitoring-kube-state-metrics             ClusterIP      10.110.30.35     <none>        8080/TCP                     20m
service/monitoring-prometheus-node-exporter       ClusterIP      10.106.84.101    <none>        9100/TCP                     20m
service/prometheus-operated                       ClusterIP      None             <none>        9090/TCP                     18m

NAME                                          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-app-app-python-0   Bound    pvc-3fb4cd92-064b-444b-a3a3-4791f9fa97c6   5Mi        RWO            standard       6d23h
persistentvolumeclaim/data-app-app-python-1   Bound    pvc-b31b51b4-36ac-4101-a957-b4c36074d7c0   5Mi        RWO            standard       6d23h

NAME                                                                     DATA   AGE
configmap/config                                                         1      6d21h
configmap/kube-root-ca.crt                                               1      35d
configmap/monitoring-grafana                                             1      20m
configmap/monitoring-grafana-config-dashboards                           1      20m
configmap/monitoring-kube-prometheus-alertmanager-overview               1      20m
configmap/monitoring-kube-prometheus-apiserver                           1      20m
configmap/monitoring-kube-prometheus-cluster-total                       1      20m
configmap/monitoring-kube-prometheus-controller-manager                  1      20m
configmap/monitoring-kube-prometheus-etcd                                1      20m
configmap/monitoring-kube-prometheus-grafana-datasource                  1      20m
configmap/monitoring-kube-prometheus-grafana-overview                    1      20m
configmap/monitoring-kube-prometheus-k8s-coredns                         1      20m
configmap/monitoring-kube-prometheus-k8s-resources-cluster               1      20m
configmap/monitoring-kube-prometheus-k8s-resources-multicluster          1      20m
configmap/monitoring-kube-prometheus-k8s-resources-namespace             1      20m
configmap/monitoring-kube-prometheus-k8s-resources-node                  1      20m
configmap/monitoring-kube-prometheus-k8s-resources-pod                   1      20m
configmap/monitoring-kube-prometheus-k8s-resources-workload              1      20m
configmap/monitoring-kube-prometheus-k8s-resources-workloads-namespace   1      20m
configmap/monitoring-kube-prometheus-kubelet                             1      20m
configmap/monitoring-kube-prometheus-namespace-by-pod                    1      20m
configmap/monitoring-kube-prometheus-namespace-by-workload               1      20m
configmap/monitoring-kube-prometheus-node-cluster-rsrc-use               1      20m
configmap/monitoring-kube-prometheus-node-rsrc-use                       1      20m
configmap/monitoring-kube-prometheus-nodes                               1      20m
configmap/monitoring-kube-prometheus-nodes-darwin                        1      20m
configmap/monitoring-kube-prometheus-persistentvolumesusage              1      20m
configmap/monitoring-kube-prometheus-pod-total                           1      20m
configmap/monitoring-kube-prometheus-prometheus                          1      20m
configmap/monitoring-kube-prometheus-proxy                               1      20m
configmap/monitoring-kube-prometheus-scheduler                           1      20m
configmap/monitoring-kube-prometheus-workload-total                      1      20m
configmap/prometheus-monitoring-kube-prometheus-prometheus-rulefiles-0   34     18m
```

### Pods (po)
- **alertmanager-monitoring-kube-prometheus-alertmanager-0**: The Alertmanager pod is running successfully with 2/2 containers ready.
- **app-app-python-0, app-app-python-1**: Pods for an app based on Python are both running without issues.
- **monitoring-grafana-6f8d546676-nsv5g**: The Grafana pod is running with 3/3 containers ready, indicating successful deployment and readiness.
- **monitoring-kube-prometheus-operator-5fbb66b4b-zvtg9**: The pod for the Prometheus Operator is running with 1/1 container ready.
- **monitoring-kube-state-metrics-74f4d8858f-mxmxl**: The kube-state-metrics pod is running with 1/1 container ready.
- **monitoring-prometheus-node-exporter-f8bnm**: The node-exporter pod is running with 1/1 container ready.
- **prometheus-monitoring-kube-prometheus-prometheus-0**: The Prometheus pod is running with 2/2 containers ready.

### StatefulSets (sts)
- **alertmanager-monitoring-kube-prometheus-alertmanager**: StatefulSet for Alertmanager is running with 1/1 pod ready.
- **app-app-python**: StatefulSet for the app based on Python is running with 2/2 pods ready.
- **prometheus-monitoring-kube-prometheus-prometheus**: StatefulSet for Prometheus is running with 1/1 pod ready.

### Services (svc)
- Services like Alertmanager, Grafana, Prometheus, kube-state-metrics, etc., are defined to provide cluster-internal access to the respective components. They expose specific ports for communication within the cluster.

### PersistentVolumeClaims (pvc)
- **data-app-app-python-0, data-app-app-python-1**: PersistentVolumeClaims for the app based on Python are both bound to storage resources.

### ConfigMaps (cm)
- Various ConfigMaps exist, containing configurations and data used by different components within the Kube Prometheus Stack. These ConfigMaps hold information about Grafana, Prometheus rules, Kubernetes resources, etc.

This updated output gives an overview of the current status of different resources within the Kubernetes cluster, including pods, services, stateful sets, persistent volume claims, and configuration maps. It indicates successful deployment and readiness of most components, ensuring the smooth functioning of the monitored applications and observability tools.



## 4. Utilize Grafana Dashboards:

### Explore existing dashboards to find information about your cluster:
  1. Check CPU and Memory consumption of your StatefulSet.
    <img width="1631" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/832b56bd-527c-418b-a9f4-e5406db7cd27">
    
  #### 1.1.app-app-python-0
<img width="1628" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/7cf72afe-8923-49c6-8241-11b69651b60d">


<img width="1637" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/68834b8a-2933-4a48-bdae-59279e6cf379">

  ### 1.2 app-app-python-1

<img width="1631" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/cb419d13-8dc3-4d42-960d-4283cf67f277">
<img width="1629" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/336fd91f-ab62-4104-9d9a-c42a1b0a6d5e">

        

  2. Identify Pods with higher and lower CPU usage in the default namespace.
    <img width="1655" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/bf73198c-3a49-46f0-a936-f641ec5dcdfa">

  3. Monitor node memory usage in percentage and megabytes.
    <img width="1630" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/aa5616a7-c4e4-4212-84fe-f21480a3c7a1">

  4. Count the number of pods and containers managed by the Kubelet service.
    <img width="1626" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/bb32a83d-9d1e-43ed-ae87-dc514dd467fb">

  5. Evaluate network usage of Pods in the default namespace.
    <img width="1634" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/5f10aba0-d84a-432a-87d4-ea765e2ba383">

  6. Determine the number of active alerts; also check the Web UI with `minikube service monitoring-kube-prometheus-alertmanager`.
    <img width="1634" alt="image" src="https://github.com/nikitosing/core-course-labs/assets/32202610/990772c7-a0dd-467f-9ec8-211219f34f2a">



## Task 2

```bash
❯ kubectl exec app-app-python-1 -- cat /workdir/index.html
Defaulted container "app-python" out of: app-python, install (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```

## Bonus task

```bash
❯ kubectl exec app-app-python-1 -- cat /workdir/index.html
Defaulted container "app-python" out of: app-python, install-0 (init), install-1 (init), install-2 (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
install-1 was here
install-2 was here
```