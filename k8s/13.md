# Lab 13: Kubernetes StatefulSet

## Task 1: Implement StatefulSet in Helm Chart

```
bobievnodir@bobievnodir-nu:~/iu/devops/k8s$ helm install --dry-run --debug my-python-web ./my-helm-app --values ./my-helm-app/values.python.yaml
install.go:214: [debug] Original chart version: ""
install.go:231: [debug] CHART PATH: /home/bobievnodir/iu/devops/k8s/my-helm-app

NAME: my-python-web
LAST DEPLOYED: Sun Dec 10 02:14:14 2023
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
configMap:
  name: python-configmap
deployment:
  containerName: python-web
  label: python
  name: python-app
  serviceAccountName: internal-app
envConfigMap:
  name: python-configmap-env
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: bobievnodir/app_python
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: true
  host: python.app
  name: python-ingress
  path: /
  pathType: ImplementationSpecific
  tls: []
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
replicaCount: 3
resources: {}
securityContext: {}
service:
  label: python
  name: python-web-app-svc
  port: 5000
  protocol: TCP
  targetPort: 5000
  type: LoadBalancer
serviceAccount:
  annotations: {}
  automount: true
  create: false
  name: ""
statefulset:
  containerName: stateful-python-web
  label: python
  name: stateful-python-app
  serviceAccountName: stateful-internal-app
  serviceName: stateful-python-svc
storage:
  create: true
  name: data
  size: 1Mi
  storageClass: standard
tolerations: []
volumeMounts: []
volumes: []

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
configMap:
  name: python-configmap
deployment:
  containerName: python-web
  label: python
  name: python-app
  serviceAccountName: internal-app
envConfigMap:
  name: python-configmap-env
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: bobievnodir/app_python
  tag: latest
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: true
  host: python.app
  name: python-ingress
  path: /
  pathType: ImplementationSpecific
  tls: []
library-chart:
  global: {}
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
replicaCount: 3
resources: {}
securityContext: {}
service:
  label: python
  name: python-web-app-svc
  port: 5000
  protocol: TCP
  targetPort: 5000
  type: LoadBalancer
serviceAccount:
  annotations: {}
  automount: true
  create: false
  name: ""
statefulset:
  containerName: stateful-python-web
  label: python
  name: stateful-python-app
  serviceAccountName: stateful-internal-app
  serviceName: stateful-python-svc
storage:
  create: true
  name: data
  size: 1Mi
  storageClass: standard
tolerations: []
volumeMounts: []
volumes: []

HOOKS:
---
# Source: my-helm-app/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 5' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: my-helm-app/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
       "helm.sh/hook": "pre-install"
       "helm.sh/hook-delete-policy": hook-succeeded,hook-failed
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 5' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: my-helm-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "my-python-web-my-helm-app-test-connection"
  labels:
    helm.sh/chart: my-helm-app-0.1.0
    app.kubernetes.io/name: my-helm-app
    app.kubernetes.io/instance: my-python-web
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['my-python-web-my-helm-app:5000']
  restartPolicy: Never
MANIFEST:
---
# Source: my-helm-app/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: python-configmap
data:
  config.json: "{\n    \"owner\": \"Bobiev Nodir\",\n    \"version\": \"1.0.0\",\n    \"course\": \"DevOps\"\n}"
---
# Source: my-helm-app/templates/env-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: python-configmap-env
data:
  APP_OWNER: "Bobiev Nodir"
  APP_VERSION: "1.0.0"
  APP_COURSE: "DevOps"
---
# Source: my-helm-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: "python-web-app-svc"
spec:
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 5000
      targetPort: 5000
  selector:
    app: "python"
---
# Source: my-helm-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: stateful-python-app
  labels:
    app: python
spec:
  replicas: 3
  serviceName: python-web-app-svc
  selector:
    matchLabels:
      app: python
  template:
    metadata:
      labels:
        app: python
    spec:
      serviceAccountName: stateful-internal-app
      containers:
        - name: stateful-python-web
          image: "bobievnodir/app_python:latest"
          resources:
            requests:
              memory: "64Mi"
              cpu: "250m"
            limits:
              memory: "128Mi"
              cpu: "500m" 
          ports:
          - containerPort: 5000
          env:
            - name: "PASSWORD"
              valueFrom:
                secretKeyRef:
                  name: db-user-pass
                  key: password
            - name: "USERNAME"
              valueFrom:
                secretKeyRef:
                  name: db-user-pass
                  key: username
          envFrom:
            - configMapRef:
                name: python-configmap-env
          volumeMounts:
            - name: config-volume
              mountPath: /config
              readOnly: true
            - name: data
              mountPath: /data
      volumes:
        - name: config-volume
          configMap:
            name: python-configmap
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: standard
        resources:
          requests:
            storage: 1Mi
---
# Source: my-helm-app/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: python-ingress
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
    - host: python.app
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: python-web-app-svc
                port:
                  number: 5000
```

## Task 2: StatefulSet Exploration and Optimization

### Research and Documentation

#### Kubernetes resources:

```
bobievnodir@bobievnodir-nu:~/iu/devops/k8s$ kubectl get po,sts,svc,pvc
NAME                        READY   STATUS    RESTARTS   AGE
pod/stateful-python-app-0   1/1     Running   0          113s
pod/stateful-python-app-1   1/1     Running   0          109s
pod/stateful-python-app-2   1/1     Running   0          105s

NAME                                   READY   AGE
statefulset.apps/stateful-python-app   3/3     113s

NAME                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/kubernetes           ClusterIP      10.96.0.1       <none>        443/TCP          25d
service/python-web-app-svc   LoadBalancer   10.109.150.47   <pending>     5000:32492/TCP   114s

NAME                                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/data-my-vault-0              Bound    pvc-01f02844-0de6-4d77-bcec-916751248e0e   10Gi       RWO            standard       25d
persistentvolumeclaim/data-stateful-python-app-0   Bound    pvc-b6c2c7d4-7615-4f3a-8587-2de2ad192b83   1Mi        RWO            standard       113s
persistentvolumeclaim/data-stateful-python-app-1   Bound    pvc-b709b9ee-56ac-4708-9895-dadd40e859bd   1Mi        RWO            standard       110s
persistentvolumeclaim/data-stateful-python-app-2   Bound    pvc-1e8097a8-e42f-44ca-b802-6a77d1ce1d68   1Mi        RWO            standard       105s
```

#### Minikube to start service:

```
bobievnodir@bobievnodir-nu:~$ minikube service python-web-app-svc
|-----------|--------------------|-------------|---------------------------|
| NAMESPACE |        NAME        | TARGET PORT |            URL            |
|-----------|--------------------|-------------|---------------------------|
| default   | python-web-app-svc |        5000 | http://192.168.49.2:32492 |
|-----------|--------------------|-------------|---------------------------|
ðŸƒ  Starting tunnel for service python-web-app-svc.
|-----------|--------------------|-------------|------------------------|
| NAMESPACE |        NAME        | TARGET PORT |          URL           |
|-----------|--------------------|-------------|------------------------|
| default   | python-web-app-svc |             | http://127.0.0.1:37455 |
|-----------|--------------------|-------------|------------------------|
ðŸŽ‰  Opening service default/python-web-app-svc in default browser...
â—  Because you are using a Docker driver on linux, the terminal needs to be open to run it.
Found ffmpeg: /opt/yandex/browser-beta/libffmpeg.so
	avcodec: 3882340
	avformat: 3876196
	avutil: 3746916
Ffmpeg version is OK! Let's use it.
[869858:869858:1210/014853.130073:ERROR:isolated_origin_util.cc(74)] Ignoring port number in isolated origin: chrome://custo
[869908:869913:1210/014853.156395:ERROR:file_path_watcher_inotify.cc(315)] inotify_init() failed: Too many open files (24)
Opening in existing browser session.
```

#### Content of visits file for each pod
```
bobievnodir@bobievnodir-nu:~/iu/devops/k8s$ for POD in $( kubectl get pods -n default -o jsonpath='{.items[*].metadata.name}' ); do
> echo "===== $POD ====="
> kubectl exec $POD -it -- cat /data/visits
> echo
> done
===== stateful-python-app-0 =====
27.0
===== stateful-python-app-1 =====
28.0
===== stateful-python-app-2 =====
26.0
bobievnodir@bobievnodir-nu:~/iu/
```

#### Why there are different numbers in visits file for each pod?:
There is a bunch of reasons to that:
* For each pod, a persistent volume is created but these volumes are syncronized between each other.
* Kubernetes directs a user request to one of the pods, and the decision of which pod the request should be directed to is completely up to kubernetes.
* In the application there is a variable which starts from 0 every time the application starts. The app doesn't read from what is written in visits but instead it writes the value of that variable to visits.


### Ordering Guarantee and Parallel Operations:

#### Explain why ordering guarantees are unnecessary for your app?:
The application is simple and stateless, meaning each request is entirely independent of other requests and does not maintain any state in between, so the order of events is not important.

#### Paraller Operations:

```
bobievnodir@bobievnodir-nu:~$ kubectl get pods
NAME                    READY   STATUS              RESTARTS   AGE
postinstall-hook        0/1     ContainerCreating   0          3s
stateful-python-app-0   0/1     ContainerCreating   0          3s
stateful-python-app-1   0/1     ContainerCreating   0          3s
stateful-python-app-2   0/1     ContainerCreating   0          3s
```